<h1><%= title %></h1>
<h4><%= tutorial.description %></h4>

<div id='tutorial-material'>
  <% for (var i = 0; i < tutorial.content.length; i++) { %>
    <% if (tutorial.content[i].type == 'text') { %>
      <p><%= tutorial.content[i].data %></p>
    <% } else if (tutorial.content[i].type == 'image') { %>
      <p><img src='<%= tutorial.content[i].data %>' alt='Image' /></p>
    <% } else if (tutorial.content[i].type == 'video') { %>
      <p><video src='<%= tutorial.content[i].data %>' controls>HTML5 video not supported in this browser</video></p>
    <% } %>
  <% } %>
</div>

<div id='tutorial-exercise'>
  <% if (questions.length > 0) { %>
    <% if (questions.length > 1) { %>
      <h2>Exercises</h2>
    <% } else { %>
      <h2>Exercise</h2>
    <% } %>

    <% for (var i = 0; i < questions.length; i++) { %>
      <% var is_mc = true; %>

      <div class='question'>
        <p><%= questions[i].question %></p>

        <% if (questions[i].choice1) { %>
          <label><input type="radio" name="answer-mc-<%= i %>" value="1"> <%= questions[i].choice1 %></label>
        <% } else { %>
          <input type="text" id="open_answer-<%= i %>">
        <% } %>
        <% if (questions[i].choice2) { %>
          <label><input type="radio" name="answer-mc-<%= i %>" value="2"> <%= questions[i].choice2 %></label>
        <% } %>
        <% if (questions[i].choice3) { %>
          <label><input type="radio" name="answer-mc-<%= i %>" value="3"> <%= questions[i].choice3 %></label>
        <% } %>
        <% if (questions[i].choice4) { %>
          <label><input type="radio" name="answer-mc-<%= i %>" value="4"> <%= questions[i].choice4 %></label>
        <% } %>

        <button class='quiz-submit' 
          id="submit-<%= i %>"
          data-url='/tutorials/<%= type %>/<%= tutorial.level_num %>'
          data-questionid='<%= questions[i].question_id %>'>Submit</button>
        <button class='show-answer'
          data-url='/tutorials/<%= type %>/<%= tutorial.level_num %>'
          data-questionid="<%= questions[i].question_id %>">Show Answer</button>

      </div>
    <% } %>

    <a class='ref-link' target='_blank' href="/ref/<%= type %>">Reference sheet</a>
    <a class='ref-link' target='_blank' href="#" id='btn-toohard'>This is too hard!</a>
  <% } %>
</div>

<aside id='dialog-toohard'>
  <iframe width="420" height="315" src="https://www.youtube.com/embed/KxGRhd_iWuE?rel=0" frameborder="0" allowfullscreen></iframe>
</aside>


<script src='/js/jquery.easyModal.js' type='text/javascript'></script>
<script>
  $(document).ready(function () {
    // Linebreaks
    $('#tutorial-material p').each(function () {
      this.innerHTML = this.innerHTML.replace(/(?:\r\n|\r|\n)/g, '<br>');
    });

    // Too hard button
    $('#dialog-toohard').easyModal({
      overlayOpacity: 0.3,
      overlayColor: "#333",
      zIndex: function() { return 100000; },
      updateZIndexOnOpen: false
    });

    $('#btn-toohard').click(function (e) {
      e.preventDefault();

      $('#dialog-toohard').trigger('openModal');

      achievementGet(1);
    });

    $('.show-answer').click(function (e) {
      // Fetch the answer with a POST call
      $.post(this.dataset.url, { questionID: this.dataset.questionid }, function (data) {
        alert(data);
      });

      e.preventDefault();
    });


    // Scoring
    var difficulty = <%= tutorial.difficulty %>;
    var score = 100 * difficulty;
    var threshold = Math.ceil(score * 0.75);
    var start = Date.now();
    var end = 0;
    var errors = 0;

    <% for (var i = 0; i < questions.length; i++) { %>
      document.getElementById("submit-<%= i %>").onclick = function (event) {
        event.stopPropagation();

        // Check answer
        // TODO: POST call to check answer
        $("#submit-<%= i %>").click(function (e) {

            // Gets the user submitted solution.
            // Ternary Condition. If there's an open-answer question, get that element's value.
            // If there isn't then it's a mult-choice question, and get the value of the checked button.
            var submitted = ( ($("#open_answer-<%= i %>")) ? 
              $("#open_answer-<%= i %>").val() : $("input[name='answer-mc-<%= i %>']:checked").val());
            
            // Uses a POST call to find out if the user was correct or not.
            $.post(this.dataset.url, { user_solution : submitted, question_id : this.dataset.questionid },
              function (data) {
                alert(data);
            });

            e.preventDefault();
          });

        // Score
        end = Date.now();
        score -= (end - start) / 1000;

        // Ben's old answer validation
        // TODO: replace this with POST call (above)
        if (document.getElementById("open_answer-<%= i %>")) {
          if (document.getElementById("open_answer-<%= i %>").value === "<%= questions[i].answer %>") {
            alert("Question <%= i%>: Correct!");
          }
          else {
            errors++;
            score = score - Math.pow(2, errors);
            alert("Question <%= i %>: Incorrect...");
          }
          alert(document.getElementById("open_answer-<%= i %>").value === "<%= questions[i].answer %>");
        }
        else {
          if ($("input[name='answer-mc-<%= i %>']:checked").val() === "<%= questions[i].answer %>") {
            alert("Question <%= i%>: Correct!");
          }
          else {
            errors++;
            score = score - Math.pow(2, errors);
            alert("Question <%= i %>: Incorrect...");
          }
        }

        if (score <= 0) { score = 0; }

        // Convert score to integer
        score = parseInt(score, 10);

        if (score >= threshold) {
          alert("You passed! Score: " + score);
        }
        else {
          alert("You failed! You got: " + score + " but needed: " + threshold);
        }

        // Achievements?
        if (score < threshold) {
          achievementGet(8);
        }

        if (end - start <= 30000) {
          achievementGet(2);
        }

        // Record score for question
        $.post('/level/<%= questions[i].question_id %>/' + score, function (data) {
          // console.log(data);
        });
      };
    <% } %>
  });

</script>
